<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTU AI Academic Assistant</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        /* Custom scrollbar for output area */
        #outputArea {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #4f46e5 #e5e7eb;
        }
        #outputArea::-webkit-scrollbar {
            width: 8px;
        }
        #outputArea::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 4px;
        }
        #outputArea::-webkit-scrollbar-thumb {
            background-color: #4f46e5;
            border-radius: 4px;
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-4 sm:p-8">

    <div class="w-full max-w-2xl bg-white shadow-2xl rounded-xl p-6 md:p-8 mt-10">

        <header class="text-center mb-6 md:mb-8">
            <h1 class="text-3xl font-extrabold text-indigo-700">
                VTU Academic Assistant <span class="text-lg text-gray-500">(AI-Powered)</span>
            </h1>
            <p class="text-gray-600 mt-1">Syllabus Guidance, Notes, PYQs, & Lab Programs</p>
        </header>

        <!-- Input Section -->
        <div class="flex flex-col gap-4">
            <textarea
                id="queryInput"
                placeholder="E.g., 'What is the syllabus for 5th sem CSE DBMS module 3?' or 'Summarize the steps for the Physics lab 'Band Gap of a Semiconductor'."
                rows="4"
                class="w-full p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 resize-none text-gray-700"
            ></textarea>
            <button
                id="askButton"
                onclick="askGemini()"
                class="bg-indigo-600 text-white py-3 rounded-lg font-semibold shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 disabled:bg-indigo-400"
            >
                Get Guidance
            </button>
        </div>

        <!-- Output Section -->
        <div class="mt-8">
            <h2 class="text-xl font-bold text-gray-700 mb-3 border-b pb-2">AI Response</h2>
            <div id="outputArea" class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <p id="responseText" class="text-gray-800 leading-relaxed min-h-16">
                    Your answers will appear here. The assistant uses real-time search to provide accurate, grounded information.
                </p>
                <div id="loadingIndicator" class="hidden flex items-center justify-center space-x-2 text-indigo-600 mt-4">
                    <div class="w-4 h-4 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                    <span>Searching VTU resources...</span>
                </div>
                <div id="sourcesArea" class="mt-4 pt-4 border-t border-gray-200 hidden">
                    <h3 class="text-sm font-semibold text-gray-600 mb-2">Sources (Grounded Content):</h3>
                    <ul id="sourcesList" class="space-y-1 text-sm text-gray-500">
                        <!-- Sources will be inserted here -->
                    </ul>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- API & Configuration ---

        // IMPORTANT: In a real Python backend, the API key would be stored securely and calls made server-side.
        // For this hackathon demo/single file, we simulate the backend call in JavaScript.
        const apiKey = ""; // Canvas environment will automatically populate this
        const apiUrl = https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey};

        // --- DOM Elements ---
        const queryInput = document.getElementById('queryInput');
        const askButton = document.getElementById('askButton');
        const responseText = document.getElementById('responseText');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const sourcesArea = document.getElementById('sourcesArea');
        const sourcesList = document.getElementById('sourcesList');

        /**
         * Cleans up markdown characters and formats the text for display.
         * @param {string} text 
         * @returns {string}
         */
        function formatMarkdown(text) {
            if (!text) return "";
            // Replace simple markdown formatting with HTML tags
            text = text.replace(/## (.*)/g, '<strong>$1</strong>');
            text = text.replace(/\\(.)\\*/g, '<strong>$1</strong>');
            text = text.replace(/\(.)\*/g, '<em>$1</em>');
            text = text.replace(/\n/g, '<br>');
            return text;
        }

        /**
         * The main function to call the Gemini API with Google Search grounding.
         */
        async function askGemini() {
            const userQuery = queryInput.value.trim();

            if (!userQuery) {
                responseText.innerHTML = '<span class="text-red-500">Please enter a question about your VTU academic needs.</span>';
                return;
            }

            // Set loading state
            askButton.disabled = true;
            responseText.innerHTML = '';
            loadingIndicator.classList.remove('hidden');
            sourcesArea.classList.add('hidden');
            sourcesList.innerHTML = '';

            try {
                // System instruction to prime the model as a VTU expert
                const systemPrompt = "You are an expert academic assistant specializing in Visvesvaraya Technological University (VTU) curriculum, syllabus, and examination patterns. Your goal is to provide concise, accurate guidance on syllabus topics, notes, Previous Year Questions (PYQs), and lab programs. Format the response clearly and professionally.";

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    // IMPORTANT: Using the Google Search Tool for grounding on real-time VTU data
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                // Exponential backoff retry loop
                let response;
                let delay = 1000;
                const maxRetries = 3;

                for (let i = 0; i < maxRetries; i++) {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        break; // Success
                    }

                    if (i === maxRetries - 1) {
                        throw new Error('API failed after multiple retries.');
                    }

                    console.warn(Attempt ${i + 1} failed. Retrying in ${delay / 1000}s...);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }

                if (!response || !response.ok) {
                    throw new Error(HTTP error! status: ${response ? response.status : 'Unknown'});
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    // 1. Extract the generated text
                    const text = candidate.content.parts[0].text;
                    responseText.innerHTML = formatMarkdown(text);

                    // 2. Extract grounding sources (citations)
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;

                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    // 3. Display sources
                    if (sources.length > 0) {
                        sourcesArea.classList.remove('hidden');
                        sources.forEach((source, index) => {
                            const li = document.createElement('li');
                            li.innerHTML = `<a href="${source.uri}" target="_blank" class="text-indigo-500 hover:text-indigo-700 hover:underline transition duration-150">
                                [${index + 1}] ${source.title}
                            </a>`;
                            sourcesList.appendChild(li);
                        });
                    }

                } else {
                    responseText.innerHTML = '<span class="text-yellow-600">Assistant could not generate a valid response. Please try rephrasing your query.</span>';
                    console.error('Unexpected API response structure:', result);
                }

            } catch (error) {
                responseText.innerHTML = <span class="text-red-500">An error occurred: ${error.message}. Check your network connection.</span>;
                console.error('Fetch error:', error);
            } finally {
                // Reset loading state
                askButton.disabled = false;
                loadingIndicator.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
